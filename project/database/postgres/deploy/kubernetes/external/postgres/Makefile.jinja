build: \
	build-pod \
	sleep \
	create-user

build-pod:
	kubectl apply -f configmap.yaml > /dev/null
	kubectl apply -f service.yaml > /dev/null
	kubectl apply -f deployment.yaml > /dev/null

sleep:
	sleep 5

create-user:
	kubectl exec -it --namespace={{ project_name }} svc/postgres -- \
		psql -U postgres -tc "CREATE USER minos WITH ENCRYPTED PASSWORD 'min0s';" || true

create-database:
	kubectl exec -it --namespace={{ project_name }} svc/postgres -- \
		psql -U postgres -tc "CREATE DATABASE $(DB_NAME) OWNER minos;"


restart:
	kubectl rollout restart --namespace={{ project_name }} deployment postgres > /dev/null
