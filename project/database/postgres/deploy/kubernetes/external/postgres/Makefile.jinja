build:
	$(MAKE) build-pod
	$(MAKE) create-user

build-pod:
	kubectl apply -f configmap.yaml > /dev/null
	kubectl apply -f service.yaml > /dev/null
	kubectl apply -f deployment.yaml > /dev/null

create-user:
	kubectl wait --for=condition=available --namespace={{ project_name }} deployment/postgres > /dev/null
	kubectl exec -it --namespace={{ project_name }} svc/postgres -- \
		psql -U postgres -tc "CREATE USER minos WITH ENCRYPTED PASSWORD 'min0s';" || true

create-database:
	kubectl wait --for=condition=available --namespace={{ project_name }} deployment/postgres > /dev/null
	kubectl exec -it --namespace={{ project_name }} svc/postgres -- \
		psql -U postgres -tc "CREATE DATABASE $(DB_NAME) OWNER minos;"


restart:
	kubectl rollout restart --namespace={{ project_name }} deployment/postgres > /dev/null
